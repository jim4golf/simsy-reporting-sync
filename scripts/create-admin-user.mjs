#!/usr/bin/env node
/**
 * Create Initial Admin User
 *
 * One-time setup script to create the first admin user in the auth_users table.
 * Uses the same PBKDF2-SHA256 parameters as the API worker (crypto.ts).
 *
 * Prerequisites:
 *   1. 001-init.sql and 002-auth.sql must already be applied to the database.
 *   2. Node.js >= 18 (for native crypto.subtle support)
 *
 * Usage:
 *   node scripts/create-admin-user.mjs
 *
 * Environment variables (or prompted interactively):
 *   DATABASE_URL  — PostgreSQL connection string
 *                   e.g. postgres://simsy_reporting:pass@host:5432/simsy_reporting
 *
 * Example:
 *   DATABASE_URL="postgres://simsy_reporting:xxx@localhost:5432/simsy_reporting" \
 *     node scripts/create-admin-user.mjs
 */

import { createInterface } from 'node:readline';
import { webcrypto } from 'node:crypto';
import { randomBytes } from 'node:crypto';

// Use the global crypto if available (Node 20+), otherwise polyfill
const subtle = globalThis.crypto?.subtle || webcrypto.subtle;

// ── PBKDF2 parameters — must match src/utils/crypto.ts exactly ──────────────
const PBKDF2_ITERATIONS = 600_000;
const SALT_BYTES = 16;
const HASH_BYTES = 32; // 256 bits

// ── Crypto helpers ──────────────────────────────────────────────────────────

function toBase64(buf) {
  return Buffer.from(buf).toString('base64');
}

function fromBase64(b64) {
  return new Uint8Array(Buffer.from(b64, 'base64'));
}

function generateSalt() {
  const salt = randomBytes(SALT_BYTES);
  return toBase64(salt);
}

async function hashPassword(password, salt) {
  const encoder = new TextEncoder();
  const saltBytes = fromBase64(salt);

  const keyMaterial = await subtle.importKey(
    'raw',
    encoder.encode(password),
    'PBKDF2',
    false,
    ['deriveBits'],
  );

  const bits = await subtle.deriveBits(
    {
      name: 'PBKDF2',
      salt: saltBytes,
      iterations: PBKDF2_ITERATIONS,
      hash: 'SHA-256',
    },
    keyMaterial,
    HASH_BYTES * 8,
  );

  return toBase64(bits);
}

// ── Interactive prompts ─────────────────────────────────────────────────────

const rl = createInterface({ input: process.stdin, output: process.stderr });

function ask(question) {
  return new Promise((resolve) => {
    rl.question(question, resolve);
  });
}

async function askPassword(question) {
  // Node.js doesn't have a built-in hidden input, so we just use normal prompt
  // For production, you'd use a library like 'read' — but this is a one-time script
  return ask(question);
}

// ── Main ────────────────────────────────────────────────────────────────────

async function main() {
  console.error('');
  console.error('╔══════════════════════════════════════════════════════════╗');
  console.error('║      S-IMSY Reporting — Create Initial Admin User       ║');
  console.error('╚══════════════════════════════════════════════════════════╝');
  console.error('');

  // Collect inputs
  const email = await ask('  Admin email: ');
  if (!email || !email.includes('@')) {
    console.error('\n  ✗ Invalid email address.\n');
    process.exit(1);
  }

  const displayName = await ask('  Display name: ');
  if (!displayName) {
    console.error('\n  ✗ Display name is required.\n');
    process.exit(1);
  }

  const password = await askPassword('  Password (min 12 chars): ');
  if (!password || password.length < 12) {
    console.error('\n  ✗ Password must be at least 12 characters.\n');
    process.exit(1);
  }

  const password2 = await askPassword('  Confirm password: ');
  if (password !== password2) {
    console.error('\n  ✗ Passwords do not match.\n');
    process.exit(1);
  }

  const tenantId = (await ask('  Tenant ID [simsy-app]: ')).trim() || 'simsy-app';

  rl.close();

  // Hash the password
  console.error('\n  Hashing password (PBKDF2-SHA256, 600k iterations)...');
  const salt = generateSalt();
  const passwordHash = await hashPassword(password, salt);
  console.error('  ✓ Password hashed successfully.\n');

  // Output SQL
  const sql = `-- ============================================================================
-- S-IMSY Reporting — Initial Admin User
-- ============================================================================
-- Generated by: scripts/create-admin-user.mjs
-- Generated at: ${new Date().toISOString()}
--
-- Run this against the simsy_reporting database:
--   sudo -u postgres psql -d simsy_reporting -f admin-user.sql
-- ============================================================================

INSERT INTO auth_users (
    email,
    password_hash,
    salt,
    display_name,
    role,
    tenant_id,
    is_active,
    password_changed_at
) VALUES (
    '${email.replace(/'/g, "''")}',
    '${passwordHash}',
    '${salt}',
    '${displayName.replace(/'/g, "''")}',
    'admin',
    '${tenantId.replace(/'/g, "''")}',
    true,
    now()
)
ON CONFLICT ((lower(email))) DO NOTHING;

SELECT
    id,
    email,
    display_name,
    role,
    tenant_id,
    is_active,
    created_at
FROM auth_users
WHERE email_lower = '${email.toLowerCase().replace(/'/g, "''")}';
`;

  // Print SQL to stdout (can be piped to a file or psql)
  console.log(sql);

  console.error('  ────────────────────────────────────────────────');
  console.error('  SQL has been written to stdout.');
  console.error('');
  console.error('  To apply directly:');
  console.error('    node scripts/create-admin-user.mjs | psql -d simsy_reporting');
  console.error('');
  console.error('  Or save to file first:');
  console.error('    node scripts/create-admin-user.mjs > admin-user.sql');
  console.error('    psql -d simsy_reporting -f admin-user.sql');
  console.error('');
  console.error(`  Admin: ${email} (${displayName})`);
  console.error(`  Tenant: ${tenantId}`);
  console.error(`  Role: admin`);
  console.error('  ────────────────────────────────────────────────');
  console.error('');
}

main().catch((err) => {
  console.error('\n  ✗ Error:', err.message, '\n');
  process.exit(1);
});
